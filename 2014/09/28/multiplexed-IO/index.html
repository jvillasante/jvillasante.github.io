<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Multiplexed IO | foobar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Applications often need to block on more than one file descriptor. Whithout the aid of threads, a single process can’t even dream on blocking on more than one file descriptor at the same time. The thi">
<meta property="og:type" content="article">
<meta property="og:title" content="Multiplexed IO">
<meta property="og:url" content="http://jvillasante.github.io/2014/09/28/multiplexed-IO/">
<meta property="og:site_name" content="foobar">
<meta property="og:description" content="Applications often need to block on more than one file descriptor. Whithout the aid of threads, a single process can’t even dream on blocking on more than one file descriptor at the same time. The thi">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Multiplexed IO">
<meta name="twitter:description" content="Applications often need to block on more than one file descriptor. Whithout the aid of threads, a single process can’t even dream on blocking on more than one file descriptor at the same time. The thi">
<meta name="twitter:creator" content="@76121168">
<link rel="publisher" href="115535547770142850000">

  
    <link rel="alternative" href="/atom.xml" title="foobar" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-55271947-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">foobar</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Pseudo random stuff and thoughts</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
      <a id="nav-github-link" class="nav-icon" href="https://github.com/jvillasante"></a>
      <a id="nav-linkedin-link" class="nav-icon" href="https://www.linkedin.com/profile/view?id=73217458&trk"></a>
      <a id="nav-google-plus-link" class="nav-icon" href="https://plus.google.com/u/0/115535547770142859056/posts"></a>
      <a id="nav-twitter-link" class="nav-icon" href="https://twitter.com/jvillasante"></a>
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><input type="submit" value="&#xF002;" class="search-form-submit"><input type="hidden" name="q" value="site:http://jvillasante.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-multiplexed-IO" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2014/09/28/multiplexed-IO/" class="article-date">
  <time datetime="2014-09-28T21:09:02.000Z" itemprop="datePublished">Sep 28 2014</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Multiplexed IO
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Applications often need to block on more than one file descriptor. Whithout the aid of threads, a single process can’t even dream on blocking on more than one file descriptor at the same time. The thing is that working with multiple file descriptors is fine, so long as they are always ready to be read from or written to. But as soon as one file descriptor that is not yet ready is encountered - say, if a read() system call is issued, and there is not yet any data — the process will block, no longer able to service the other file descriptors. And this, we all know, can be a pain in the ass sometimes.</p>
<p>Here’s a real world example. Imagine blocking on a file descriptor related to interprocess communication while stdin has data pending. The application won’t know that keyboard input is pending until the blocked IPC file descriptor ultimately returns data - but what if the blocked operation never returns?</p>
<a id="more"></a>

<p>There are more than one solution to that problem, but ideally what we would like to do is that the program could sleep, freeing the processor for other tasks to be woken up only when one or more file descriptors were ready to perform I/O. An so, multiplexed I/O was born. You can go and research the subject, but in escence what multiplexed I/O does is:</p>
<ol>
<li>Multiplexed I/O: Tell me when any of these file descriptors become ready fo I/O.</li>
<li>Nothing ready? Sleep until one or more file descriptors are ready.</li>
<li>Woken up! What is ready?</li>
<li>Handle all file descriptors ready for I/O, without blocking.</li>
<li>Go back to step 1.</li>
</ol>
<p>Linux systems provides three multiplexed I/O solutions: the <em>select</em>, <em>poll</em>, and <em>epoll</em> interfaces. In this post I will only show you a piece of code I have written for work that uses <em>select</em>, but keep in mind that <em>poll</em> and it’s cousin <em>epoll</em> are much more featuring solutions.</p>
<p>At work I’m doing a project on access control with fingerprint identification. The requirement is simple. A user puts her fingerprint on the sensor and then she is prompted to press on one of two buttons for entrance or departure. The catch is that the user has only a relatively small time window to press the required button (5 seconds per requirement), otherwise the system goes to identification mode waiting for another user to place her finger.</p>
<p>As per the requirement of user spec, we have to wait 5 seconds for the user to press the required button and then go on with things, but we can’t block the thread while on waiting. One solution, of course, is launching a new thread for the button pressing functionality, but, at least in this case that is overkill. Multiplexed IO to the rescue…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">bool</span> isButtonPressed()</div><div class="line">{</div><div class="line">    <span class="keyword">int</span> fd;</div><div class="line">    <span class="keyword">struct</span> input_event event;</div><div class="line">    ssize_t bytesRead;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line">    <span class="keyword">struct</span> timeval tv;</div><div class="line">    fd_set readfds;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> buttonType = <span class="number">0</span>;</div><div class="line"></div><div class="line">    fd = open(<span class="string">"/dev/input/event0"</span>, O_RDONLY);</div><div class="line">    check(fd != -<span class="number">1</span>, <span class="string">"Error opening /dev/input/event0 for reading"</span>);</div><div class="line">    debug(<span class="string">"/dev/input/event0 oppened for reading"</span>);</div><div class="line"></div><div class="line">    <span class="comment">/* Wait on fd for input */</span></div><div class="line">    FD_ZERO(&amp;readfds);</div><div class="line">    FD_SET(fd, &amp;readfds);</div><div class="line"></div><div class="line">    <span class="comment">/* Wait up to five seconds */</span></div><div class="line">    tv.tv_sec = <span class="number">5</span>;</div><div class="line">    tv.tv_usec = <span class="number">0</span>;</div><div class="line"></div><div class="line">repeat:</div><div class="line">    ret = select(fd + <span class="number">1</span>, &amp;readfds, NULL, NULL, &amp;tv);</div><div class="line">    <span class="keyword">if</span> (ret == -<span class="number">1</span>) {</div><div class="line">        log_error(<span class="string">"select call on /dev/input/event0: an error ocurred"</span>);</div><div class="line">        <span class="keyword">goto</span> error;</div><div class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!ret) {</div><div class="line">        debug(<span class="string">"select call on /dev/input/event0: TIMEOUT"</span>);</div><div class="line">        <span class="keyword">if</span> (fd) { <span class="keyword">if</span> (close(fd) != <span class="number">0</span>) { log_error(<span class="string">"Error closing /dev/input/event0"</span>); } }</div><div class="line">        debug(<span class="string">"/dev/input/event0 closed because of timeout"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">/* File descriptor is now ready */</span></div><div class="line">    <span class="keyword">if</span> (FD_ISSET(fd, &amp;readfds)) {</div><div class="line">        bytesRead = read(fd, &amp;event, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> input_event));</div><div class="line">        check(bytesRead != -<span class="number">1</span>, <span class="string">"Read input error: call to read returned -1."</span>);</div><div class="line">        check(bytesRead == <span class="keyword">sizeof</span>(<span class="keyword">struct</span> input_event), </div><div class="line">            <span class="string">"Read input error: bytes read is not an input_event."</span>);</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (event.code) {</div><div class="line">        <span class="keyword">case</span> BTN_5:</div><div class="line">            debug(<span class="string">"IN Button Pressed"</span>);</div><div class="line">            buttonType = <span class="number">5</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> BTN_6:</div><div class="line">            debug(<span class="string">"OUT Button Pressed"</span>);</div><div class="line">            buttonType = <span class="number">6</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">default</span>:</div><div class="line">            debug(<span class="string">"UNKNOWN Button Pressed"</span>);</div><div class="line">            <span class="keyword">goto</span> repeat;</div><div class="line">        }</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (buttonType == <span class="number">0</span>) {</div><div class="line">        <span class="keyword">if</span> (fd) { <span class="keyword">if</span> (close(fd) != <span class="number">0</span>) { log_error(<span class="string">"Error closing /dev/input/event0"</span>); } }</div><div class="line">        debug(<span class="string">"/dev/input/event0 closed because UNKNOWN button was pressed"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    } <span class="keyword">else</span> {</div><div class="line">        <span class="keyword">if</span> (fd) { <span class="keyword">if</span> (close(fd) != <span class="number">0</span>) { log_error(<span class="string">"Error closing /dev/input/event0"</span>); } }</div><div class="line">        debug(<span class="string">"/dev/input/event0 closed"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    }</div><div class="line"></div><div class="line">error:</div><div class="line">    <span class="keyword">if</span> (fd) { <span class="keyword">if</span> (close(fd) != <span class="number">0</span>) { log_error(<span class="string">"Error closing /dev/input/event0"</span>); } }</div><div class="line">    debug(<span class="string">"/dev/input/event0 closed in error handler"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">}</div></pre></td></tr></table></figure>

<p>And there you have it, we were able to wait on IO without blocking. It is worth noting that this solution only works in Linux, because current versions of Linux modify the timeout automatically with the time remaining. Thus, if the timeout was set for 5 seconds, and 3 seconds elapsed before a file descriptor became ready, tv.tv_sec would containt 2 upon the call’s return. </p>
<p>And just like that, Multiplexed IO saves the day and we are now ready for another beer…</p>
<p>Thank you.</p>
<a href="&#x6d;&#x61;&#105;&#108;&#116;&#x6f;&#x3a;&#106;&#x76;&#105;&#108;&#108;&#97;&#x73;&#x61;&#x6e;&#116;&#101;&#x67;&#x6f;&#x6d;&#101;&#x7a;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#46;&#99;&#111;&#109;">&#106;&#x76;&#105;&#108;&#108;&#97;&#x73;&#x61;&#x6e;&#116;&#101;&#x67;&#x6f;&#x6d;&#101;&#x7a;&#x40;&#x67;&#109;&#97;&#x69;&#x6c;&#46;&#99;&#111;&#109;</a>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://jvillasante.github.io/2014/09/28/multiplexed-IO/" data-id="2mkg0d0wsyjbqgyf" class="article-share-link">Share</a>
      
        <a href="http://jvillasante.github.io/2014/09/28/multiplexed-IO/#disqus_thread" class="article-comment-link">Comments</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/c-programming/">c programming</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/programming/">programming</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/09/28/my-vim-setup/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          my vim setup
        
      </div>
    </a>
  
  
    <a href="/2014/09/28/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/c-programming/">c programming</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/editors/">editors</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/">others</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/productivity/">productivity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/programming/">programming</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/c-programming/" style="font-size: 10.00px;">c programming</a><a href="/tags/editors/" style="font-size: 10.00px;">editors</a><a href="/tags/others/" style="font-size: 10.00px;">others</a><a href="/tags/productivity/" style="font-size: 10.00px;">productivity</a><a href="/tags/programming/" style="font-size: 20.00px;">programming</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2014/11/24/the-only-thing-about-time/">the only thing about time</a>
          </li>
        
          <li>
            <a href="/2014/09/28/my-vim-setup/">my vim setup</a>
          </li>
        
          <li>
            <a href="/2014/09/28/multiplexed-IO/">Multiplexed IO</a>
          </li>
        
          <li>
            <a href="/2014/09/28/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2014 Julio C. Villasante<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    
<script>
  var disqus_shortname = 'jvillasante';
  
  var disqus_url = 'http://jvillasante.github.io/2014/09/28/multiplexed-IO/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">

  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>



<script src="/js/script.js" type="text/javascript"></script>


  </div>
</body>
</html>